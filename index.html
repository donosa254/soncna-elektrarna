<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Sončne Elektrarne: Poročilo za Stranko</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 380px;
            }
        }
        .flow-arrow {
            color: #0d9488;
            font-size: 2rem;
            line-height: 1;
        }
        @media print {
            /* Basic A4 page setup */
            @page {
                size: A4 portrait; /* Set page size to A4 portrait */
                margin: 1cm; /* Set default margins for print */
            }

            .no-print {
                display: none !important;
            }
            body {
                background-color: #ffffff;
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact; /* Ensure background colors and images are printed */
                print-color-adjust: exact;
            }
            .container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            /* Adjust chart container height for print to auto to prevent cropping */
            .chart-container {
                height: auto !important;
                max-height: none !important;
            }
            /* Ensure text colors are maintained in print */
            .text-gray-700, .text-teal-600, .text-gray-600, .text-teal-500, .text-red-500, .text-gray-500 {
                color: #333333 !important; /* Darker color for readability */
            }
            /* Specific adjustments for layout to fit A4 if needed, e.g., grid to block */
            main.grid {
                display: block; /* Change grid to block for simpler printing flow */
            }
            main.grid > div {
                width: 100%;
                margin-bottom: 1.5rem; /* Add some margin between sections for readability */
            }
            .lg\:col-span-3, .md\:col-span-2 {
                grid-column: auto !important; /* Reset grid spans */
            }
        }
    </style>
</head>
<body class="text-gray-700">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-teal-600 mb-2">Zmanjšajte stroške električne energije s sončno elektrarno na ključ</h1>
            <p id="customerIntro" class="text-lg text-gray-600 max-w-3xl mx-auto">Pregled prihrankov ob namestitvi hibridne sončne elektrarne.</p>
        </header>

        <section id="inputSection" class="no-print bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-teal-600 mb-4">Vnesite Podatke Stranke</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="customerName" class="block text-gray-700 text-sm font-bold mb-2">Ime stranke:</label>
                    <input type="text" id="customerName" value="" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="customerAddress" class="block text-gray-700 text-sm font-bold mb-2">Naslov:</label>
                    <input type="text" id="customerAddress" value="" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="customerPostalCode" class="block text-gray-700 text-sm font-bold mb-2">Poštna številka:</label>
                    <input type="text" id="customerPostalCode" value="" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="customerPhone" class="block text-gray-700 text-sm font-bold mb-2">Telefon:</label>
                    <input type="tel" id="customerPhone" value="" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="customerEmail" class="block text-gray-700 text-sm font-bold mb-2">E-pošta:</label>
                    <input type="email" id="customerEmail" value="" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="monthlyCostInput" class="block text-gray-700 text-sm font-bold mb-2">Trenutna mesečna poraba (€):</label>
                    <input type="number" id="monthlyCostInput" value="100" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="selfSufficiencyInput" class="block text-gray-700 text-sm font-bold mb-2">Stopnja samozadostnosti (%):</label>
                    <input type="number" id="selfSufficiencyInput" value="60" min="0" max="100" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
            </div>
            <div class="flex justify-center mt-6 space-x-4">
                <button id="calculateAndPrintBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">Prikaži Poročilo</button>
            </div>
        </section>

        <!-- Display Section for Customer Data (initially hidden, shown on report display) -->
        <section id="customerDetailsDisplay" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden print:block">
            <h2 class="text-2xl font-bold text-teal-600 mb-4">Stranka</h2>
            <div class="text-gray-700 text-lg text-left">
                <p id="displayCustomerName"></p>
                <p id="displayCustomerAddress"></p>
                <p id="displayCustomerPostalCode"></p>
                <p id="displayCustomerPhone"></p>
                <p id="displayCustomerEmail"></p>
            </div>
        </section>


        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-12">
            <!-- Added mt-12 here -->

            <div class="lg:col-span-3 bg-white rounded-lg shadow-lg p-6 flex flex-col md:flex-row justify-around items-center text-center">
                <div class="p-4">
                    <p id="displayMonthlyCost" class="text-5xl font-bold text-teal-500">100€</p>
                    <p class="text-md text-gray-500 mt-2">Trenutna Mesečna Poraba</p>
                </div>
                <div class="p-4">
                    <p id="displaySelfSufficiency" class="text-5xl font-bold text-teal-500">60%</p>
                    <p class="text-md text-gray-500 mt-2">Stopnja Samozadostnosti</p>
                </div>
                <div class="p-4">
                    <p id="displayAnnualSavings" class="text-5xl font-bold text-teal-500">720€</p>
                    <p class="text-md text-gray-500 mt-2">Letni Prihranek</p>
                </div>
                <div class="p-4">
                    <p id="displayThirtyYearSavings" class="text-5xl font-bold text-red-500">21.600€</p>
                    <p class="text-md text-gray-500 mt-2">Prihranek v 30.letih</p>
                </div>
            </div>
            
            <div class="md:col-span-2 lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-1">Primerjava Stroškov Elektrike</h2>
                <p class="text-gray-600 mb-4">Graf prikazuje predviden strošek elektrike pred in po namestitvi sončne elektrarne ter vaš prihranek, na letni in 30-letni ravni (brez upoštevanja inflacije ali sprememb cen elektrike).</p>
                <div class="chart-container mx-auto">
                    <canvas id="costComparisonChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-1">Samozadostnost</h2>
                <p class="text-gray-600 mb-4">Po namestitvi sončne elektrarne boste del svoje električne energije proizvedli sami, kar bistveno zmanjša odvisnost od javnega omrežja.</p>
                <div class="chart-container mx-auto">
                    <canvas id="selfSufficiencyChart"></canvas>
                </div>
            </div>

            <div class="lg:col-span-3 bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-center">Z nami je vaš prehod na sončno energijo preprost, transparenten in brezskrben</h2>
                <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                    <div class="text-center p-4 rounded-md w-48">
                        <span class="text-5xl">💡</span>
                        <h3 class="font-bold mt-2">1. Napredna informativna ponudba</h3>
                    </div>
                    <div class="flow-arrow transform md:rotate-0 rotate-90">&rarr;</div>
                    <div class="text-center p-4 rounded-md w-48">
                        <span class="text-5xl">📝</span>
                        <h3 class="font-bold mt-2">2. Strokovni ogled objekta s svetovanjem</h3>
                    </div>
                    <div class="flow-arrow transform md:rotate-0 rotate-90">&rarr;</div>
                    <div class="text-center p-4 rounded-md w-48">
                        <span class="text-5xl">📊</span>
                        <h3 class="font-bold mt-2">3. Izračun, izris in predstavitev investicije</h3>
                    </div>
                    <div class="flow-arrow transform md:rotate-0 rotate-90">&rarr;</div>
                    <div class="text-center p-4 rounded-md w-48">
                        <span class="text-5xl">📄</span>
                        <h3 class="font-bold mt-2">4. Priprava dokumentacije</h3>
                    </div>
                    <div class="flow-arrow transform md:rotate-0 rotate-90">&rarr;</div>
                    <div class="text-center p-4 rounded-md w-48">
                         <span class="text-5xl">⚡</span>
                        <h3 class="font-bold mt-2">5. Montaža in priključitev</h3>
                    </div>
                </div>
                <div class="text-center text-lg text-gray-700 mt-8">
                    <p>Kontaktiral vas bo naš komercialist : <strong class="font-bold">Fredi Donoša</strong>, m: <strong class="font-bold">040 458 834</strong> in vam pripravil informativno ponudbo in se z vami zmenil za strokoven ogled v kolikor boste to želeli</p>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12 py-6 border-t border-gray-200">
            <p class="text-sm text-gray-500 mb-2">Vaše podatke bomo izključno uporabili samo za namen informativne ponudbe</p>
            <img src="For signature.png" alt="© Omnisev d.o.o." class="mx-auto h-12" onerror="this.onerror=null;this.src='https://placehold.co/150x50/f0f4f8/0d9488?text=%C2%A9%20Omnisev%20d.o.o.';">
        </footer>

    </div>

    <script>
        let costComparisonChartInstance;
        let selfSufficiencyChartInstance;

        Chart.register(ChartDataLabels);

        document.addEventListener('DOMContentLoaded', () => {

            const primaryColor = '#0d9488';
            const secondaryColor = '#059669';
            const accentColor1 = '#14b8a6';
            const accentColor2 = '#2dd4bf';
            const accentColor3 = '#5eead4';

            const costBeforeColor = '#E74C3C'; // Red
            const costAfterColor = '#F39C12'; // Yellow-Orange
            const savingsColor = secondaryColor; // Green, using secondaryColor
            const networkPurchaseColor = '#C0392B'; // Darker Red for Network Purchase


            const tooltipConfig = {
                plugins: {
                    tooltip: {
                        backgroundColor: '#ffffff',
                        titleColor: '#333333',
                        bodyColor: '#555555',
                        borderColor: '#dddddd',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            title: function(tooltipItems) {
                                const item = tooltipItems[0];
                                let label = item.chart.data.labels[item.dataIndex];
                                return Array.isArray(label) ? label.join(' ') : label;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: function(value, context) {
                            // Format numbers with dot as thousands separator
                            if (context.chart.id === 'costComparisonChart') {
                                return value.toLocaleString('sl-SI', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + '€';
                            } else if (context.chart.id === 'selfSufficiencyChart') {
                                return value.toLocaleString('sl-SI', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + '%';
                            }
                            return '';
                        },
                        color: '#333',
                        font: {
                            weight: 'bold'
                        },
                        offset: 25 // Adjusted offset for all labels to be higher above the bars
                    }
                }
            };
            
            function wrapLabel(str, maxLen) {
                if (!str || str.length <= maxLen) {
                    return str;
                }
                const words = str.split(' ');
                let currentLine = '';
                const lines = [];
                for (let word of words) {
                    if ((currentLine + word).length + 1 > maxLen && currentLine.length > 0) {
                        lines.push(currentLine.trim());
                        currentLine = '';
                    }
                    currentLine += word + ' ';
                }
                lines.push(currentLine.trim());
                return lines.filter(line => line.length > 0);
            }

            const calculateAndPrintReport = () => {
                const customerName = document.getElementById('customerName').value;
                const customerAddress = document.getElementById('customerAddress').value;
                const customerPostalCode = document.getElementById('customerPostalCode').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const customerEmail = document.getElementById('customerEmail').value;

                // Update the customer display fields
                document.getElementById('displayCustomerName').textContent = customerName;
                document.getElementById('displayCustomerAddress').textContent = customerAddress;
                document.getElementById('displayCustomerPostalCode').textContent = customerPostalCode;
                document.getElementById('displayCustomerPhone').textContent = customerPhone;
                document.getElementById('displayCustomerEmail').textContent = customerEmail;


                let introText = `Pregled prihrankov ob namestitvi hibridne sončne elektrarne.`;
                document.getElementById('customerIntro').textContent = introText;

                const monthlyCost = parseFloat(document.getElementById('monthlyCostInput').value) || 0;
                const selfSufficiencyRate = parseFloat(document.getElementById('selfSufficiencyInput').value) / 100 || 0;

                const annualCostBefore = monthlyCost * 12;
                const thirtyYearCostBefore = annualCostBefore * 30;
                const annualCostAfter = annualCostBefore * (1 - selfSufficiencyRate);
                const annualSavings = annualCostBefore * selfSufficiencyRate;
                const thirtyYearSavings = annualSavings * 30;

                document.getElementById('displayMonthlyCost').textContent = `${monthlyCost.toFixed(0)}€`;
                document.getElementById('displaySelfSufficiency').textContent = `${(selfSufficiencyRate * 100).toFixed(0)}%`;
                document.getElementById('displayAnnualSavings').textContent = `${annualSavings.toFixed(0)}€`;
                document.getElementById('displayThirtyYearSavings').textContent = `${thirtyYearSavings.toLocaleString('sl-SI', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}€`;

                // Destroy existing chart instances before creating new ones
                if (costComparisonChartInstance) {
                    costComparisonChartInstance.destroy();
                    costComparisonChartInstance = null; // Explicitly set to null
                }
                if (selfSufficiencyChartInstance) {
                    selfSufficiencyChartInstance.destroy();
                    selfSufficiencyChartInstance = null; // Explicitly set to null
                }


                const ctxCostComparison = document.getElementById('costComparisonChart')?.getContext('2d');
                if (ctxCostComparison) {
                    costComparisonChartInstance = new Chart(ctxCostComparison, {
                        type: 'bar',
                        data: {
                            labels: ['Letni', '30-letni'],
                            datasets: [
                                {
                                    label: 'Strošek Pred SE',
                                    data: [annualCostBefore, thirtyYearCostBefore],
                                    backgroundColor: costBeforeColor,
                                    borderRadius: 4
                                },
                                {
                                    label: 'Strošek Po SE',
                                    data: [annualCostAfter, thirtyYearCostBefore - thirtyYearSavings],
                                    backgroundColor: costAfterColor,
                                    borderRadius: 4
                                },
                                {
                                    label: 'Prihranek',
                                    data: [annualSavings, thirtyYearSavings],
                                    backgroundColor: savingsColor,
                                    borderRadius: 4
                                }
                            ]
                        },
                        options: {
                            ...tooltipConfig,
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: { display: true, text: 'Obdobje' }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Znesek (€)' }
                                }
                            },
                            plugins: {
                                ...tooltipConfig.plugins,
                                datalabels: {
                                    ...tooltipConfig.plugins.datalabels,
                                    formatter: function(value, context) {
                                        return value.toLocaleString('sl-SI', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + '€';
                                    },
                                    color: function(context) {
                                        // Red color for the savings label, default for others
                                        if (context.datasetIndex === 2) { // Prihranek dataset
                                            return costBeforeColor; // Red color for savings label
                                        }
                                        return '#333'; // Default text color for other labels
                                    },
                                    offset: 25, // Uniform positive offset to place labels ABOVE the bars
                                    align: 'end', // Align to the 'end' of the bar (top for vertical bars)
                                    rotation: 0,
                                    display: function(context) {
                                        // This ensures all labels are displayed unless the value is zero
                                        const dataValue = context.dataset.data[context.dataIndex];
                                        return dataValue !== 0; 
                                    },
                                    backgroundColor: null, // No background color
                                    borderRadius: 0, // No border radius
                                    padding: 0, // No padding
                                    font: {
                                        weight: 'bold', 
                                        size: 14 
                                    },
                                    clip: false /* Prevents labels from being cut off if they extend beyond chart area */
                                }
                            }
                        }
                    });
                }

                const ctxSelfSufficiency = document.getElementById('selfSufficiencyChart')?.getContext('2d');
                if (ctxSelfSufficiency) {
                    selfSufficiencyChartInstance = new Chart(ctxSelfSufficiency, {
                        type: 'doughnut',
                        data: {
                            labels: ['Lastna Proizvodnja', 'Nakup iz Omrežja'],
                            datasets: [{
                                label: 'Vir energije',
                                data: [selfSufficiencyRate * 100, (1 - selfSufficiencyRate) * 100],
                                backgroundColor: [savingsColor, networkPurchaseColor], 
                                borderColor: '#ffffff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            ...tooltipConfig,
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                ...tooltipConfig.plugins,
                                datalabels: {
                                    ...tooltipConfig.plugins.datalabels,
                                    formatter: function(value, context) {
                                        return value.toLocaleString('sl-SI', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + '%';
                                    },
                                    color: '#fff',
                                    textShadow: '1px 1px 2px rgba(0,0,0,0.5)',
                                    align: 'center', 
                                    anchor: 'center' 
                                }
                            }
                        }
                    });
                }

                // Hide input section and show display section
                document.getElementById('inputSection').classList.add('hidden');
                document.getElementById('customerDetailsDisplay').classList.remove('hidden');

                // Trigger print
                setTimeout(() => {
                    window.print();
                }, 500); 
            };

            document.getElementById('calculateAndPrintBtn').addEventListener('click', calculateAndPrintReport);
            
            // On initial load, keep inputs visible, do not trigger print
            // You might want to call calculateAndPrintReport() here if you want it to print on load,
            // but for typical usage, it's better to wait for user interaction.
        });
    </script>

</body>
</html>
